<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="四技二專甄選入學志願調查系統" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; 
        style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
        img-src 'self' data: https:;" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <base target="_top" />
    <title>四技二專甄選入學志願調查系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous" />
    <style>
        /* 引入 Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        :root {
            /* 現代柔和配色 */
            --bs-primary: #5D9CEC;
            /* 柔和藍 */
            --bs-primary-rgb: 93, 156, 236;
            --bs-secondary: #AAB2BD;
            /* 淺灰 */
            --bs-success: #48CFAD;
            /* 薄荷綠 */
            --bs-danger: #FC6E51;
            /* 珊瑚紅 */
            --bs-warning: #FFCE54;
            /* 太陽黃 */
            --bs-info: #4FC1E9;
            --bs-light: #F5F7FA;
            --bs-dark: #434A54;

            /* 字體設定 */
            --bs-body-font-family: 'Noto Sans TC', system-ui, -apple-system, sans-serif;
            --bs-body-color: #434A54;
            --bs-body-bg: #F5F7FA;
        }

        body {
            font-family: var(--bs-body-font-family);
            color: var(--bs-body-color);
            background-color: var(--bs-body-bg) !important;
        }

        .navbar-brand {
            font-weight: 700;
            color: #434A54 !important;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background-color: #FFFFFF;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--bs-primary), var(--bs-success));
            opacity: 0.8;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            color: var(--bs-dark);
            font-weight: 700;
        }

        .btn {
            border-radius: 8px;
            font-weight: 500;
            padding: 0.5rem 1.2rem;
            transition: all 0.25s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .btn-primary {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
        }

        .btn-primary:hover {
            background-color: #4A89DC;
            border-color: #4A89DC;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(93, 156, 236, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .form-control,
        .form-select {
            border-radius: 8px;
            border: 1px solid #CCD1D9;
            padding: 0.6rem 0.8rem;
            transition: all 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 0.25rem rgba(93, 156, 236, 0.15);
        }

        /* 學生資料卡片優化 */
        .student-card {
            border: none;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
            transition: all 0.3s ease;
        }

        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.08);
        }

        .student-card-header {
            background-color: #F8F9FA;
            padding: 1rem;
            border-bottom: 1px solid #E6E9ED;
            border-radius: 12px 12px 0 0;
            font-weight: 700;
            color: var(--bs-dark);
        }

        .student-card-body {
            padding: 1.5rem;
        }

        .student-info {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .student-info-item {
            flex: 1;
            min-width: 200px;
        }

        .student-info-label {
            color: #AAB2BD;
            font-size: 0.9rem;
        }

        .student-info-value {
            font-size: 1.1rem;
            color: #434A54;
        }

        /* 報名費用標籤 */
        .fee-badge {
            font-size: 1rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
        }

        /* 回應式設計調整 */
        @media (max-width: 768px) {
            .student-info-item {
                min-width: 150px;
            }
        }

        .nav-tabs .nav-link {
            border: none;
            color: #656D78;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link:hover {
            color: var(--bs-primary);
            background-color: rgba(93, 156, 236, 0.05);
        }

        .nav-tabs .nav-link.active {
            color: var(--bs-primary);
            border-bottom: 3px solid var(--bs-primary);
            background-color: transparent;
        }

        /* Styles for Statistics Tab */
        .group-container {
            margin-bottom: 30px;
        }

        .count-badge {
            font-size: 0.9em;
        }

        #loadingMessageStats {
            text-align: center;
            font-size: 1.2em;
            margin-top: 50px;
        }

        #errorMessageStats {
            color: red;
        }
    </style>
</head>

<body class="bg-light">
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid px-2 px-md-4">
            <a class="navbar-brand" id="navbarBrand" href="#"></a>
        </div>
    </nav>

    <div class="container-fluid my-4 px-2 px-md-4">
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="survey-tab" data-bs-toggle="tab" data-bs-target="#survey-tab-pane"
                    type="button" role="tab" aria-controls="survey-tab-pane" aria-selected="true">班級學生志願</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-tab-pane"
                    type="button" role="tab" aria-controls="stats-tab-pane" aria-selected="false">各志願選填人數統計</button>
            </li>
        </ul>
        <div class="tab-content" id="mainTabsContent">
            <div class="tab-pane fade show active" id="survey-tab-pane" role="tabpanel" aria-labelledby="survey-tab"
                tabindex="0">
                <!-- 老師資訊卡片 -->
                <div class="card fs-4 mb-3">
                    <div class="card-body">
                        <div class="row text-center mt-3">
                            <div class="col-12 col-sm-6 col-md mb-3">
                                <div class="text-muted">班級</div>
                                <div id="teacherClass"></div>
                            </div>
                            <div class="col-12 col-sm-6 col-md mb-3">
                                <div class="text-muted">老師</div>
                                <div id="teacherName"></div>
                            </div>
                            <div class="col-12 col-sm-6 col-md mb-3">
                                <div class="text-muted">班級人數</div>
                                <div id="classCount"></div>
                            </div>
                            <div class="col-12 col-sm-6 col-md mb-3">
                                <div class="text-muted">填答人數</div>
                                <div id="answeredCount"></div>
                            </div>
                            <div class="col-12 col-sm-6 col-md mb-3">
                                <div class="text-muted">參加集報人數</div>
                                <div id="joinedCount"></div>
                            </div>
                            <div class="col-12 col-sm-6 col-md mb-3">
                                <div class="text-muted">報名倒數計時</div>
                                <div id="countdownTimer"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 學生資料表格卡片 -->
                <div class="card fs-4 mb-3">
                    <div class="card-body">
                        <div id="student-data-container">
                            <!-- 學生資料卡片將由 JavaScript 動態產生 -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="stats-tab-pane" role="tabpanel" aria-labelledby="stats-tab" tabindex="0">
                <div class="container pt-3">
                    <h1 class="mb-4 text-center">各志願選填統計結果</h1>
                    <div id="loadingMessageStats">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">載入中...</span>
                        </div>
                        <p>正在載入統計資料，請稍候...</p>
                    </div>
                    <div class="mb-3">
                        <label for="groupFilterStats" class="form-label">統測報考群(類)：</label>
                        <select id="groupFilterStats" class="form-select">
                            <option value="">所有群(類)</option>
                            <!-- 群(類)選項將由 JavaScript 動態填入 -->
                        </select>
                    </div>
                    <div id="statisticsResultStats" class="mt-4">
                        <!-- 統計結果將顯示於此 -->
                    </div>
                    <div id="errorMessageStats" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center py-4 text-muted px-2">
        © <span id="footerText"></span>
    </footer>

    <script>
        // 解析後端傳過來的 JSON 資料
        const pageData = JSON.parse('<?= pageData ?>');
        const { user, configs, loginEmail, serviceUrl, headers, data } = pageData;

        document.addEventListener("DOMContentLoaded", function () {
            // 初始化頁面資料
            initializePageData();

            try {
                if (!headers || headers.length === 0) {
                    throw new Error('沒有表頭資料');
                }

                const container = document.getElementById('student-data-container');

                if (!data || data.length === 0) {
                    container.innerHTML = `
                            <div class="alert alert-info text-center" role="alert">
                                目前沒有學生資料
                            </div>
                        `;
                    return;
                }

                data.sort((a, b) => {
                    const serialA = a[headers.indexOf('統一入學測驗報名序號')] || "";
                    const serialB = b[headers.indexOf('統一入學測驗報名序號')] || "";
                    return serialA.localeCompare(serialB, "zh-TW");
                });

                // 產生學生資料卡片
                const cardsHtml = data.map(row => {
                    const studentNameIndex = headers.indexOf('考生姓名');
                    const groupIndex = headers.indexOf('報考群(類)名稱');
                    const classIndex = headers.indexOf('班級名稱');
                    const paymentTypeIndex = headers.indexOf('繳費身分');
                    const feeIndex = headers.indexOf('報名費');
                    const isJoinedIndex = headers.indexOf('是否參加集體報名');

                    // 找出志願相關的索引
                    const wishIndexes = headers
                        .map((header, index) => ({ header, index }))
                        .filter(item => /志願[1-6]校系名稱/.test(item.header));

                    // 建立志願資訊HTML，只包含非空白的志願
                    const wishesHtml = wishIndexes
                        .map(({ header, index }) => {
                            if (row[isJoinedIndex] === '否' || !row[index]) {
                                return '';
                            }
                            // 只取出「(該校可報志願數」之前的文字
                            const wishText = row[index].split('(該校可報志願數')[0].trim();
                            return `
                                    <div class="student-info-item">
                                        <div class="student-info-label">${header}</div>
                                        <div class="student-info-value">${wishText}</div>
                                    </div>
                                `;
                        })
                        .filter(html => html !== '')
                        .join('');

                    // 建立卡片HTML
                    return `
                            <div class="student-card">
                                <div class="student-card-header">
                                    ${row[studentNameIndex]} 
                                    <small class="text-muted">
                                    (${row[classIndex] || ''} / ${row[groupIndex] || ''} / ${row[paymentTypeIndex] || ''} ${row[isJoinedIndex] === '是' ? `/ ${row[feeIndex]} 元` : ''})
                                    </small>
                                </div>
                                <div class="student-card-body">
                                    <div class="student-info">
                                        ${row[isJoinedIndex] === '否' ?
                            '<div class="alert alert-danger mb-0">此學生不參加集體報名</div>' :
                            (wishesHtml ? '<div class="alert alert-success mb-0">' + wishesHtml + '</div>' : '<div class="alert alert-warning mb-0">此學生尚未填寫志願</div>')}
                                    </div>
                                </div>
                            </div>
                        `;
                }).join('');

                container.innerHTML = cardsHtml;

            } catch (error) {
                console.error('資料處理錯誤:', error);
                const container = document.querySelector('.container-fluid');
                container.innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            載入資料時發生錯誤，請重新整理頁面或聯絡系統管理員。
                            <br>
                            錯誤訊息：${error.message}
                        </div>
                    `;
            }
        });

        // 初始化頁面資料
        function initializePageData() {
            // 導航列
            const navBrand = document.getElementById('navbarBrand');
            if (navBrand) {
                navBrand.href = serviceUrl;
                navBrand.textContent = configs['系統名稱'] || '';
            }

            // 教師資訊
            document.getElementById('teacherClass').textContent = user['班級'] || '';
            document.getElementById('teacherName').textContent = user['姓名'] || '';
            document.getElementById('classCount').textContent = data.length;

            // 計算填答和參加人數
            const isJoinedIndex = headers.indexOf('是否參加集體報名');
            const answeredCount = data.filter(row => row[isJoinedIndex] !== '').length;
            const joinedCount = data.filter(row => row[isJoinedIndex] === '是').length;
            document.getElementById('answeredCount').textContent = answeredCount;
            document.getElementById('joinedCount').textContent = joinedCount;

            // 頁尾
            const footerText = document.getElementById('footerText');
            if (footerText) {
                footerText.textContent = configs['系統名稱'] || '';
            }
        }

        // 統計頁籤延遲載入
        let statsLoaded = false;
        document.getElementById('stats-tab').addEventListener('shown.bs.tab', function () {
            if (!statsLoaded) {
                statsLoaded = true;
                google.script.run
                    .withSuccessHandler(populateGroupFilterStats)
                    .withFailureHandler(function (error) { console.error('載入群類失敗:', error); })
                    .getUniqueGroupNames();

                google.script.run
                    .withSuccessHandler(displayStats)
                    .withFailureHandler(function (error) { console.error('載入統計失敗:', error); })
                    .getRawStatisticsData();
            }
        });

        function updateCountdown() {
            const endTime = new Date(configs['系統關閉時間']);
            const countdownTimer = document.getElementById("countdownTimer");
            const now = new Date();
            const timeLeft = endTime - now;

            if (timeLeft < 0) {
                clearInterval(timerInterval);
                countdownTimer.innerHTML = "<span id='countdownTimer' class='text-danger'><strong>報名截止！</strong></span>";
                return;
            }

            const padZero = num => num.toString().padStart(2, '0');
            const seconds = padZero(Math.floor((timeLeft / 1000) % 60));
            const minutes = padZero(Math.floor((timeLeft / 1000 / 60) % 60));
            const hours = Math.floor(timeLeft / 1000 / 60 / 60);

            if (hours > 0) {
                countdownTimer.innerHTML = `<strong class="text-danger">${hours} 小時 ${minutes} 分鐘</strong>`;
            } else if (minutes > 0) {
                countdownTimer.innerHTML = `<strong class="text-danger">${minutes} 分鐘 ${seconds} 秒</strong>`;
            } else {
                countdownTimer.innerHTML = `<strong class="text-danger">${seconds} 秒</strong>`;
            }
        }

        const timerInterval = setInterval(updateCountdown, 1000);
        updateCountdown();

        // --- Statistics Tab Functions ---
        let rawDataStats = {};

        function populateGroupFilterStats(data) {
            if (data && data.error) {
                console.error("載入群類資料錯誤:", data.error);
                const errorDiv = document.getElementById('errorMessageStats');
                errorDiv.textContent = '載入群類篩選選項時發生錯誤：' + data.error;
                return;
            }

            const groupNames = data.groupNames || [];
            const selectElement = document.getElementById('groupFilterStats');
            selectElement.innerHTML = '<option value="">所有群(類)</option>';

            groupNames.forEach(groupName => {
                const option = document.createElement('option');
                option.value = escapeHtmlStats(groupName);
                option.textContent = escapeHtmlStats(groupName);
                selectElement.appendChild(option);
            });

            selectElement.addEventListener('change', function () {
                filterAndDisplayStatistics(this.value);
            });
        }

        function displayStats(data) {
            const loadingMsg = document.getElementById('loadingMessageStats');
            if (loadingMsg) {
                loadingMsg.style.display = 'none';
            }

            if (data && data.error) {
                displayErrorStats({ message: data.error });
                return;
            }

            // 依照 data keys(類群代碼+類群名稱) 的順序顯示統計資料
            rawDataStats = {};
            const groupNames = Object.keys(data).sort();
            groupNames.forEach((groupName) => rawDataStats[groupName] = data[groupName] || []);
            filterAndDisplayStatistics('');
        }

        function filterAndDisplayStatistics(selectedGroup) {
            const resultDiv = document.getElementById('statisticsResultStats');
            resultDiv.innerHTML = '';

            const dataToDisplay = {};
            if (selectedGroup && rawDataStats[selectedGroup]) {
                dataToDisplay[selectedGroup] = rawDataStats[selectedGroup];
            } else if (!selectedGroup) {
                Object.assign(dataToDisplay, rawDataStats);
            }

            if (Object.keys(dataToDisplay).length === 0) {
                resultDiv.innerHTML = '<p class="text-center">目前尚無符合篩選條件的統計資料可顯示。</p>';
                return;
            }

            for (const groupName in dataToDisplay) {
                const groupData = dataToDisplay[groupName];
                if (groupData.length === 0) continue;

                let groupHtml = `<div class="group-container card">
                                        <div class="card-header bg-primary text-white">
                                            <h2 class="group-title card-title" style="color: white; border-bottom: none; margin-bottom: 0;">${escapeHtmlStats(groupName)}</h2>
                                        </div>
                                        <ul class="list-group list-group-flush">`;

                groupData.forEach(item => {
                    groupHtml += `<li class="list-group-item">
                                        <span>${escapeHtmlStats(item.name)}</span>
                                        <span class="badge bg-secondary rounded-pill count-badge">${item.count} 人</span>
                                      </li>`;
                });
                groupHtml += `</ul></div>`;
                resultDiv.innerHTML += groupHtml;
            }
        }

        function displayErrorStats(error) {
            const loadingMsg = document.getElementById('loadingMessageStats');
            if (loadingMsg) {
                loadingMsg.style.display = 'none';
            }
            const errorDiv = document.getElementById('errorMessageStats');
            console.error('統計資料載入錯誤:', error);
            errorDiv.textContent = '載入統計資料時發生錯誤：' + (error.message || '未知錯誤') + '. 請檢查主控台獲取更多資訊。';
        }

        function escapeHtmlStats(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        // --- End of Statistics Tab Functions ---
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ"
        crossorigin="anonymous"></script>
</body>

</html>